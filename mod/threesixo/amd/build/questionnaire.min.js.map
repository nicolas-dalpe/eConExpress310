{"version":3,"sources":["../src/questionnaire.js"],"names":["define","$","Templates","Notification","Ajax","Str","ModalFactory","ModalEvents","responses","questionnaire","registerEvents","each","data","questionnaireTable","fromUser","toUser","threesixtyId","promises","call","methodname","args","threesixtyid","fromuserid","touserid","done","result","response","item","value","options","children","selected","find","removeClass","addClass","comment","commentTextArea","val","prototype","click","e","preventDefault","row","parent","hasClass","forId","attr","optionRadio","removeAttr","radio","itemid","hover","saveResponses","finalise","trim","toUserFullname","anonymous","get_strings","key","component","param","messages","showConfirmationDialogue","fail","exception","submitResponses","complete","notificationData","message","type","addNotification","window","location","redirurl","title","confirmationMessage","confirmButtonTextPromise","get_string","confirmModalPromise","create","body","large","types","SAVE_CANCEL","when","confirmButtonText","modal","setSaveButtonText","show","getRoot","on","hidden","setBody","save"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD code for the frequently used comments chooser for the marking guide grading form.\n *\n * @module     mod_threesixo/questionnaire\n * @class      view\n * @package    core\n * @copyright  2016 Jun Pataleta <jun@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery',\n    'core/templates',\n    'core/notification',\n    'core/ajax',\n    'core/str',\n    'core/modal_factory',\n    'core/modal_events'\n], function($, Templates, Notification, Ajax, Str, ModalFactory, ModalEvents) {\n\n    var responses = [];\n    var questionnaire = function() {\n        this.registerEvents();\n\n        $('[data-region=\"question-row\"]').each(function() {\n            responses[$(this).data('itemid')] = null;\n        });\n\n        var questionnaireTable = $('[data-region=\"questionnaire\"]');\n        var fromUser = questionnaireTable.data('fromuserid');\n        var toUser = questionnaireTable.data('touserid');\n        var threesixtyId = questionnaireTable.data('threesixtyid');\n\n        var promises = Ajax.call([\n            {\n                methodname: 'mod_threesixo_get_responses',\n                args: {\n                    threesixtyid: threesixtyId,\n                    fromuserid: fromUser,\n                    touserid: toUser\n                }\n            }\n        ]);\n\n        promises[0].done(function(result) {\n            $.each(result.responses, function() {\n                var response = this;\n                responses[response.item] = response.value;\n\n                $('[data-region=\"question-row\"]').each(function() {\n                    if ($(this).data('itemid') === response.item) {\n                        var options = $(this).children('.scaleoption');\n                        if (options) {\n                            options.each(function() {\n                                // Mark selected option as selected.\n                                var selected = $(this).find('label');\n                                if (selected.data('value') == response.value) {\n                                    selected.removeClass('label-default');\n                                    selected.removeClass('label-info');\n                                    selected.addClass('label-success');\n                                }\n                            });\n                        }\n                        var comment = $(this).find('.comment');\n                        if (comment) {\n                            var commentTextArea = $(this).find('textarea');\n                            commentTextArea.val(response.value);\n                        }\n                    }\n                });\n            });\n        });\n    };\n\n    questionnaire.prototype.registerEvents = function() {\n        $('.scaleoption').click(function(e) {\n            e.preventDefault();\n\n            var row = $(this).parent('[data-region=\"question-row\"]');\n            var options = row.find('label');\n\n            // Deselect the option that has been selected.\n            $.each(options, function() {\n                if ($(this).hasClass('label-success')) {\n                    $(this).removeClass('label-success');\n                    $(this).addClass('label-default');\n\n                    var forId = $(this).attr('for');\n                    var optionRadio = $(\"#\" + forId);\n                    optionRadio.removeAttr('checked');\n                }\n            });\n\n            // Mark selected option as selected.\n            var selected = $(this).find('label');\n            selected.removeClass('label-default');\n            selected.removeClass('label-info');\n            selected.addClass('label-success');\n\n            // Mark hidden radio button as checked.\n            var radio = $(\"#\" + selected.attr('for'));\n            radio.attr('checked', 'checked');\n            var itemid = row.data('itemid');\n\n            // Add this selected value to the array of responses.\n            responses[itemid] = selected.data('value');\n        });\n\n        $('.scaleoptionlabel').hover(function(e) {\n            e.preventDefault();\n\n            if (!$(this).hasClass('label-success')) {\n                if ($(this).hasClass('label-default')) {\n                    $(this).removeClass('label-default');\n                    $(this).addClass('label-info');\n                } else {\n                    $(this).addClass('label-default');\n                    $(this).removeClass('label-info');\n                }\n            }\n        });\n\n        $(\"#save-feedback\").click(function() {\n            saveResponses(false);\n        });\n\n        $(\"#submit-feedback\").click(function() {\n            saveResponses(true);\n        });\n    };\n\n    /**\n     * Save the responses.\n     *\n     * @param {boolean} finalise\n     */\n    function saveResponses(finalise) {\n        $('.comment').each(function() {\n            responses[$(this).data('itemid')] = $(this).val().trim();\n        });\n\n        var questionnaireTable = $('[data-region=\"questionnaire\"]');\n        var toUser = questionnaireTable.data('touserid');\n        var toUserFullname = questionnaireTable.data('tousername');\n        var threesixtyId = questionnaireTable.data('threesixtyid');\n        var anonymous = questionnaireTable.data('anonymous');\n\n        if (anonymous && finalise) {\n            // Show confirmation dialogue to anonymise the feedback responses.\n            var messageStrings = [\n                {\n                    key: 'finaliseanonymousfeedback',\n                    component: 'mod_threesixo'\n                },\n                {\n                    key: 'confirmfinaliseanonymousfeedback',\n                    component: 'mod_threesixo',\n                    param: {\n                        'name': toUserFullname\n                    }\n                }\n            ];\n\n            Str.get_strings(messageStrings, 'mod_threesixo').done(function(messages) {\n                showConfirmationDialogue(messages[0], messages[1], threesixtyId, toUser, responses, finalise);\n            }).fail(Notification.exception);\n        } else {\n            // Just save the responses.\n            submitResponses(threesixtyId, toUser, responses, finalise);\n        }\n    }\n\n    /**\n     * Send the responses to the server.\n     *\n     * @param {number} threesixtyId\n     * @param {number} toUser\n     * @param {array} responses\n     * @param {boolean} finalise\n     */\n    function submitResponses(threesixtyId, toUser, responses, finalise) {\n        var promises = Ajax.call([\n            {\n                methodname: 'mod_threesixo_save_responses',\n                args: {\n                    threesixtyid: threesixtyId,\n                    touserid: toUser,\n                    responses: responses,\n                    complete: finalise\n                }\n            }\n        ]);\n\n        promises[0].done(function(response) {\n            var messageStrings = [\n                {\n                    key: 'responsessaved',\n                    component: 'mod_threesixo'\n                },\n                {\n                    key: 'errorresponsesavefailed',\n                    component: 'mod_threesixo'\n                }\n            ];\n\n            Str.get_strings(messageStrings).done(function(messages) {\n                var notificationData = {};\n                if (response.result) {\n                    notificationData.message = messages[0];\n                    notificationData.type = \"success\";\n                } else {\n                    notificationData.message = messages[1];\n                    notificationData.type = \"error\";\n                }\n                Notification.addNotification(notificationData);\n            }).fail(Notification.exception);\n\n            if (finalise) {\n                window.location = response.redirurl;\n            }\n        }).fail(Notification.exception);\n    }\n\n    /**\n     * Renders the confirmation dialogue to submit and finalise the responses.\n     *\n     * @param {string} title\n     * @param {string} confirmationMessage\n     * @param {number} threesixtyId\n     * @param {number} toUser\n     * @param {Array} responses\n     * @param {boolean} finalise\n     */\n    function showConfirmationDialogue(title, confirmationMessage, threesixtyId, toUser, responses, finalise) {\n        var confirmButtonTextPromise = Str.get_string('finalise', 'mod_threesixo');\n        var confirmModalPromise = ModalFactory.create({\n            title: title,\n            body: confirmationMessage,\n            large: true,\n            type: ModalFactory.types.SAVE_CANCEL\n        });\n        $.when(confirmButtonTextPromise, confirmModalPromise).done(function(confirmButtonText, modal) {\n            modal.setSaveButtonText(confirmButtonText);\n\n            // Display the dialogue.\n            modal.show();\n\n            // On hide handler.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                // Empty modal contents when it's hidden.\n                modal.setBody('');\n            });\n\n            modal.getRoot().on(ModalEvents.save, function() {\n                submitResponses(threesixtyId, toUser, responses, finalise);\n            });\n        });\n\n    }\n\n    return questionnaire;\n});\n"],"file":"questionnaire.min.js"}